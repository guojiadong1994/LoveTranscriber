name: Build LoveTranscriber

on: [push]

jobs:
  build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10' 

    - name: Install Dependencies
      run: |
        # 安装 CPU 版 torch，防止显卡驱动导致文件过大
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
        # 安装其他依赖
        if (Test-Path "requirements.txt") {
          pip install -r requirements.txt
        } elseif (Test-Path "LoveTranscriber/requirements.txt") {
          pip install -r LoveTranscriber/requirements.txt
        }
        pip install pyinstaller

    - name: Build EXE
      run: |
        # 自动定位 main.py 目录
        if (Test-Path "main.py") {
          # 关键修改：添加 --collect-all torch 防止 DLL 丢失
          pyinstaller -F -w --clean --noconfirm --collect-all openai_whisper --collect-all torch -n "LoveTranscriber" main.py
        } elseif (Test-Path "LoveTranscriber/main.py") {
          cd LoveTranscriber
          pyinstaller -F -w --clean --noconfirm --collect-all openai_whisper --collect-all torch -n "LoveTranscriber" main.py
        } else {
          echo "Error: 找不到 main.py"
          exit 1
        }

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: LoveTranscriber-EXE
        path: |
          dist/LoveTranscriber.exe
          LoveTranscriber/dist/LoveTranscriber.exe
        overwrite: true